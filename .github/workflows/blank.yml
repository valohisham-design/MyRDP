name: CentOS7-Manual-SSH

on:
  workflow_dispatch:

jobs:
  centos7:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Start CentOS 7 Container
        run: |
          docker pull centos:7
          docker run -d \
            --name centos7 \
            --privileged \
            -p 1302:1302 \
            -p 80:80 \
            -p 443:443 \
            -p 9473:9473 \
            -p 69:69/udp \
            -v ${{ github.workspace }}:/workspace \
            --restart unless-stopped \
            centos:7 /sbin/init
          sleep 10

      - name: ๐ฅ Fix CentOS 7 Repos (Vault Only)
        run: |
          docker exec centos7 bash -c '
            rm -rf /etc/yum.repos.d/*.repo
            echo "[base]" > /etc/yum.repos.d/CentOS-Vault.repo
            echo "name=CentOS-7 - Base" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "baseurl=https://vault.centos.org/7.9.2009/os/\$basearch/" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "gpgcheck=1" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "enabled=1" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "[updates]" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "name=CentOS-7 - Updates" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "baseurl=https://vault.centos.org/7.9.2009/updates/\$basearch/" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "gpgcheck=1" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "enabled=1" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "[extras]" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "name=CentOS-7 - Extras" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "baseurl=https://vault.centos.org/7.9.2009/extras/\$basearch/" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "gpgcheck=1" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "enabled=1" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "[epel]" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "name=Extra Packages for Enterprise Linux 7 - \$basearch" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "baseurl=https://download.fedoraproject.org/pub/epel/7/\$basearch" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "enabled=1" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "gpgcheck=0" >> /etc/yum.repos.d/CentOS-Vault.repo
            yum clean all
            rm -rf /var/cache/yum
            yum makecache
          '
          echo "โ CentOS 7 repos fixed."

      - name: ๐ฆ Install Basic Tools in Container
        run: |
          docker exec centos7 bash -c '
            yum install -y epel-release
            yum install -y curl wget git nano screen tar bzip2 gcc gcc-c++ make glibc-static gmp-devel
          '

      - name: ๐ช Install tmate on Runner
        run: |
          sudo apt-get update
          sudo apt-get install -y tmate
          echo "โ tmate installed"

      - name: ๐ฅ๏ธ Start tmate SSH Session
        run: |
          tmate -F | tee /tmp/tmate.log &
          sleep 5
          TMATE_SSH=$(tmate display -p '#{tmate_ssh}' 2>/dev/null || echo "Waiting...")
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "  โ SSH SESSION READY โ COPY THIS COMMAND:"
          echo ""
          echo "  $TMATE_SSH"
          echo ""
          echo "  ๐ No password required โ just paste into your terminal."
          echo ""
          echo "  ๐ฆ Once connected, enter the container with:"
          echo "     docker exec -it centos7 bash"
          echo ""
          echo "  ๐ Your repo files are in /workspace (if you checked out code)."
          echo ""
          echo "  โ๏ธ  The container will stay alive for 6 hours."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: โณ Keep Runner Alive (6 hours)
        run: sleep 21600

      - name: ๐งน Cleanup
        if: always()
        run: |
          docker stop centos7 || true
          docker rm centos7 || true
