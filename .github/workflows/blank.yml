name: CentOS7-Tailscale-Only

on:
  workflow_dispatch:

jobs:
  centos7:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Start CentOS 7 Container
        run: |
          docker pull centos:7
          docker run -d \
            --name centos7 \
            --privileged \
            -p 1302:1302 \
            -p 80:80 \
            -p 443:443 \
            -p 9473:9473 \
            -p 69:69/udp \
            -v ${{ github.workspace }}:/workspace \
            --restart unless-stopped \
            centos:7 /sbin/init
          sleep 10

      - name: ğŸ”¥ NUKE Broken Repos & Setup VAULT Only
        run: |
          docker exec centos7 bash -c '
            # Delete ALL existing repo files (they are broken)
            rm -rf /etc/yum.repos.d/*.repo

            # Create fresh vault repo (NO mirrorlist.centos.org)
            echo "[base]" > /etc/yum.repos.d/CentOS-Vault.repo
            echo "name=CentOS-7 - Base" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "baseurl=https://vault.centos.org/7.9.2009/os/\$basearch/" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "gpgcheck=1" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "enabled=1" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "" >> /etc/yum.repos.d/CentOS-Vault.repo

            echo "[updates]" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "name=CentOS-7 - Updates" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "baseurl=https://vault.centos.org/7.9.2009/updates/\$basearch/" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "gpgcheck=1" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "enabled=1" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "" >> /etc/yum.repos.d/CentOS-Vault.repo

            echo "[extras]" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "name=CentOS-7 - Extras" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "baseurl=https://vault.centos.org/7.9.2009/extras/\$basearch/" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "gpgcheck=1" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "enabled=1" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "" >> /etc/yum.repos.d/CentOS-Vault.repo

            echo "[epel]" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "name=Extra Packages for Enterprise Linux 7 - \$basearch" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "baseurl=https://download.fedoraproject.org/pub/epel/7/\$basearch" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "enabled=1" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "gpgcheck=0" >> /etc/yum.repos.d/CentOS-Vault.repo

            # Clean yum cache
            yum clean all
            rm -rf /var/cache/yum

            # Test yum â€“ should work now
            yum repolist
          '
          echo "âœ… CentOS 7 repos fixed â€“ vault.centos.org is now the only source."

      - name: Install Tailscale
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          docker exec centos7 bash -c '
            curl -fsSL https://tailscale.com/install.sh | sh
            systemctl enable tailscaled
            systemctl start tailscaled || tailscaled 2>/dev/null &
            sleep 5
            tailscale up --authkey=$TAILSCALE_AUTH_KEY --hostname=centos7-builder --ssh
            sleep 5
            TS_IP=$(tailscale ip -4)
            echo "TAILSCALE_IP=$TS_IP" >> /etc/environment
            echo "âœ… Tailscale connected â€“ IP: $TS_IP"
          '

      - name: Display Access Info
        run: |
          TS_IP=$(docker exec centos7 tailscale ip -4 2>/dev/null)
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  âœ… CENTOS 7 CONTAINER IS READY"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "  ğŸ”µ TAILSCALE IP: $TS_IP"
          echo "     â””â”€ SSH / RDP not needed â€“ use docker exec:"
          echo ""
          echo "  ğŸ’» COMMAND TO ENTER CONTAINER:"
          echo "     docker exec -it centos7 bash"
          echo ""
          echo "  ğŸ“ YOUR WORKSPACE FILES: /workspace (if you checked out code)"
          echo ""
          echo "  âš ï¸  NEXT STEPS (DO THIS MANUALLY INSIDE CONTAINER):"
          echo "     1. yum install -y wget curl git gcc make glibc-static gmp-devel"
          echo "     2. Download your botnet source or copy from /workspace"
          echo "     3. Edit IP addresses (main.c, telnet.c, etc.)"
          echo "     4. Install Go, compilers, MySQL, etc. â€“ you have full control"
          echo ""
          echo "  â³ Container will stay alive for 24 hours."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

      - name: Keep Container Alive (24h)
        run: sleep 86400

      - name: Cleanup
        if: always()
        run: |
          docker stop centos7 || true
          docker rm centos7 || true
