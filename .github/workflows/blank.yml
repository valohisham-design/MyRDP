name: Centos 7

on:
  workflow_dispatch:

jobs:
  setup-and-run:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: 1. Update & Install Desktop (XFCE + XRDP)
        run: |
          sudo apt-get update
          sudo apt-get install -y xfce4 xfce4-goodies xrdp
          sudo systemctl enable xrdp
          sudo systemctl start xrdp
          echo "xfce4-session" | sudo tee /etc/skel/.xsession
          sudo sed -i '3 i echo "xfce4-session" > ~/.xsession' /etc/xrdp/startwm.sh
      - name: 2. Create Login User
        run: |
          USER_NAME="linuxuser"
          USER_PASS="111" 
          sudo useradd -m -s /bin/bash $USER_NAME
          echo "$USER_NAME:$USER_PASS" | sudo chpasswd
          sudo usermod -aG sudo $USER_NAME
          echo "USER_PASS=$USER_PASS" >> $GITHUB_ENV
      - name: 3. Setup Tailscale
        run: curl -fsSL https://tailscale.com/install.sh | sh

      - name: 4. Connect to Tailscale
        env:
          TS_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          if [ -z "$TS_KEY" ]; then echo "ERROR: TAILSCALE_AUTH_KEY MISSING"; exit 1; fi
          sudo tailscale up --authkey=$TS_KEY --hostname="botnet-builder" --ssh
          echo "TS_IP=$(tailscale ip -4)" >> $GITHUB_ENV
      - name: 5. Start CentOS 7 Docker Container & Fix Repos
        run: |
          docker run -d --name centos_c2 -it centos:7 /bin/bash
          
          # Fix the dead CentOS 7 mirrors by pointing to the Vault
          docker exec centos_c2 sed -i 's/mirrorlist/#mirrorlist/g' /etc/yum.repos.d/CentOS-Base.repo
          docker exec centos_c2 sed -i 's|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' /etc/yum.repos.d/CentOS-Base.repo
          
          # Install build tools
          docker exec centos_c2 yum update -y
          docker exec centos_c2 yum install -y gcc screen make wget curl git python3 php
          
          echo "CentOS 7 is now fixed and running in the background."
      - name: 6. Pre-install Ngrok on Host
        run: |
          curl -sSL https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update && sudo apt install ngrok -y
      - name: 7. Display Final Info
        run: |
          echo "======================================================="
          echo "IP ADDRESS : ${{ env.TS_IP }}"
          echo "USERNAME   : linuxuser"
          echo "PASSWORD   : ${{ env.USER_PASS }}"
          echo "======================================================="
          echo "TO START NGROK: Run 'ngrok http 80' in the RDP terminal"
          echo "======================================================="
      - name: 8. Keep Session Alive
        run: |
          while true; do sleep 60; done
